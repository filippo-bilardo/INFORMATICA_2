### **7.7 Trasformazioni**

Il Canvas di HTML5 consente di applicare trasformazioni grafiche a elementi disegnati, come spostamenti, rotazioni, ridimensionamenti e inclinazioni. Le trasformazioni si basano sull'uso di matrici 2D, che modificano il sistema di coordinate del canvas.

---

### **Tipi di trasformazioni**

1. **Traslazione (`translate`)**  
   Sposta l'origine del sistema di coordinate di un certo valore su entrambi gli assi.

   ```javascript
   ctx.translate(x, y);
   ```

2. **Rotazione (`rotate`)**  
   Ruota il sistema di coordinate attorno al punto di origine. L'angolo è in radianti.

   ```javascript
   ctx.rotate(angle);
   ```

3. **Ridimensionamento (`scale`)**  
   Espande o contrae il sistema di coordinate lungo gli assi specificati.

   ```javascript
   ctx.scale(sx, sy);
   ```

4. **Inclinazione (`transform` e `setTransform`)**  
   Applica una trasformazione generica attraverso una matrice.

   ```javascript
   ctx.transform(a, b, c, d, e, f);
   ```

   **`setTransform`** imposta una matrice di trasformazione, resettando quelle precedenti.

5. **Ripristino dello stato (`resetTransform`)**  
   Riporta il sistema di coordinate allo stato originale.

   ```javascript
   ctx.resetTransform();
   ```

---

### **Esempio: Applicare trasformazioni**

#### **HTML**
```html
<canvas id="transformCanvas" width="400" height="400" style="border:1px solid black;"></canvas>
```

#### **JavaScript**
```javascript
const canvas = document.getElementById("transformCanvas");
const ctx = canvas.getContext("2d");

// Disegna un rettangolo originale
ctx.fillStyle = "blue";
ctx.fillRect(50, 50, 100, 50);

// Traslazione
ctx.translate(150, 50);
ctx.fillStyle = "green";
ctx.fillRect(50, 50, 100, 50);

// Rotazione
ctx.resetTransform();
ctx.translate(100, 300);
ctx.rotate(Math.PI / 4);
ctx.fillStyle = "red";
ctx.fillRect(-50, -25, 100, 50); // Centra il rettangolo sull'origine

// Scala
ctx.resetTransform();
ctx.translate(300, 100);
ctx.scale(1.5, 0.5);
ctx.fillStyle = "purple";
ctx.fillRect(-50, -25, 100, 50);

// Ripristina e disegna senza trasformazioni
ctx.resetTransform();
ctx.fillStyle = "orange";
ctx.fillRect(200, 300, 100, 50);
```

---

### **Uso avanzato: Matrici personalizzate**

Le trasformazioni possono essere combinate attraverso matrici specifiche utilizzando **`transform`**.

#### **Sintassi**
```javascript
ctx.transform(a, b, c, d, e, f);
```
Dove:
- `(a, c, e)` determinano lo spostamento orizzontale.
- `(b, d, f)` determinano lo spostamento verticale.

#### **Esempio**
```javascript
ctx.setTransform(1, 0.5, -0.5, 1, 150, 50); // Inclinazione e traslazione
ctx.fillStyle = "cyan";
ctx.fillRect(0, 0, 100, 50);
```

---

### **Trasformazioni combinate e concatenazione**

Una delle tecniche più potenti è combinare più trasformazioni in sequenza per creare effetti complessi.

#### **Ordine delle trasformazioni**
L'ordine delle trasformazioni è fondamentale, poiché influisce sul risultato finale.

```javascript
// ESEMPIO 1: Ruotare, poi traslare
ctx.save();
ctx.rotate(Math.PI / 4); // Prima ruota di 45°
ctx.translate(100, 0);  // Poi trasla di 100px a destra
ctx.fillRect(0, 0, 50, 50);
ctx.restore();

// ESEMPIO 2: Traslare, poi ruotare (risultato diverso)
ctx.save();
ctx.translate(100, 0);  // Prima trasla di 100px a destra
ctx.rotate(Math.PI / 4); // Poi ruota di 45°
ctx.fillRect(0, 0, 50, 50);
ctx.restore();
```

#### **Stack delle trasformazioni con `save()` e `restore()`**
Per gestire trasformazioni complesse, usa `save()` per memorizzare lo stato corrente e `restore()` per ripristinarlo.

```javascript
// Disegna un sistema solare semplificato
function drawSolarSystem() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Trasla all'origine (centro del canvas)
    ctx.translate(canvas.width / 2, canvas.height / 2);
    
    // Disegna il sole
    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.arc(0, 0, 30, 0, Math.PI * 2);
    ctx.fill();
    
    // Orbita della Terra
    ctx.beginPath();
    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.arc(0, 0, 150, 0, Math.PI * 2);
    ctx.stroke();
    
    // Salva lo stato prima di disegnare la Terra
    ctx.save();
    
    // Ruota per posizionare la Terra (animazione)
    const time = new Date();
    ctx.rotate(((2 * Math.PI) / 60) * time.getSeconds() + 
              ((2 * Math.PI) / 60000) * time.getMilliseconds());
    
    // Trasla all'orbita della Terra
    ctx.translate(150, 0);
    
    // Disegna la Terra
    ctx.fillStyle = "blue";
    ctx.beginPath();
    ctx.arc(0, 0, 15, 0, Math.PI * 2);
    ctx.fill();
    
    // Orbita della Luna
    ctx.beginPath();
    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.arc(0, 0, 30, 0, Math.PI * 2);
    ctx.stroke();
    
    // Ruota per posizionare la Luna (più veloce)
    ctx.rotate(((2 * Math.PI) / 6) * time.getSeconds() + 
              ((2 * Math.PI) / 6000) * time.getMilliseconds());
    
    // Trasla all'orbita della Luna
    ctx.translate(30, 0);
    
    // Disegna la Luna
    ctx.fillStyle = "lightgray";
    ctx.beginPath();
    ctx.arc(0, 0, 5, 0, Math.PI * 2);
    ctx.fill();
    
    // Ripristina lo stato precedente
    ctx.restore();
}

// Animazione
function animate() {
    drawSolarSystem();
    requestAnimationFrame(animate);
}

animate();
```

### **Trasformazioni e interattività**

Le trasformazioni possono essere usate per creare elementi interattivi che rispondono agli input dell'utente.

```javascript
let angle = 0;
let scale = 1;

canvas.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left - canvas.width / 2;
    const y = e.clientY - rect.top - canvas.height / 2;
    
    // Calcola l'angolo in base alla posizione del mouse
    angle = Math.atan2(y, x);
    
    // Calcola il fattore di scala in base alla distanza dal centro
    const distance = Math.sqrt(x*x + y*y);
    scale = 1 + distance / 200;
    
    // Ridisegna con le nuove trasformazioni
    draw();
});

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(angle);
    ctx.scale(scale, scale);
    
    // Disegna una freccia
    ctx.beginPath();
    ctx.moveTo(-50, -25);
    ctx.lineTo(50, 0);
    ctx.lineTo(-50, 25);
    ctx.closePath();
    ctx.fillStyle = 'green';
    ctx.fill();
    
    ctx.restore();
}

// Disegno iniziale
draw();
```

---

### **Esercizio pratico: Crea un orologio analogico**

**Obiettivo:** Utilizzare trasformazioni per disegnare un orologio analogico con rotazioni dinamiche.

#### **HTML**
```html
<canvas id="clockCanvas" width="400" height="400" style="border:1px solid black;"></canvas>
```

#### **JavaScript**
```javascript
const canvas = document.getElementById("clockCanvas");
const ctx = canvas.getContext("2d");

function drawClock() {
    const now = new Date();
    const sec = now.getSeconds();
    const min = now.getMinutes();
    const hour = now.getHours();

    ctx.clearRect(0, 0, canvas.width, canvas.height); // Pulisci il canvas
    ctx.translate(canvas.width / 2, canvas.height / 2); // Centro del canvas

    // Disegna il quadrante
    ctx.beginPath();
    ctx.arc(0, 0, 150, 0, Math.PI * 2);
    ctx.strokeStyle = "black";
    ctx.lineWidth = 5;
    ctx.stroke();

    // Disegna le lancette
    ctx.save(); // Salva lo stato corrente

    // Lancetta delle ore
    ctx.rotate(((hour % 12) + min / 60) * Math.PI / 6); // Angolo orario
    ctx.fillStyle = "black";
    ctx.fillRect(-5, -50, 10, 100); // Rettangolo orario
    ctx.restore(); // Ripristina lo stato salvato
    ctx.save();

    // Lancetta dei minuti
    ctx.rotate((min + sec / 60) * Math.PI / 30); // Angolo minuti
    ctx.fillStyle = "gray";
    ctx.fillRect(-3, -70, 6, 140); // Rettangolo minuti
    ctx.restore(); // Ripristina lo stato salvato
    ctx.save();

    // Lancetta dei secondi
    ctx.rotate(sec * Math.PI / 30); // Angolo secondi
    ctx.fillStyle = "red";
    ctx.fillRect(-2, -80, 4, 160); // Rettangolo secondi
    ctx.restore(); // Ripristina lo stato salvato

    ctx.resetTransform(); // Ripristina lo stato iniziale
}

setInterval(drawClock, 1000); // Aggiorna l'orologio ogni secondo
```

---

### **Conclusioni**

Le trasformazioni di Canvas permettono di manipolare gli oggetti in modo dinamico, rendendolo uno strumento potente per creare grafica avanzata e animazioni. La possibilità di combinare trasformazioni apre un'ampia gamma di possibilità per applicazioni interattive e visivamente accattivanti. Nei prossimi capitoli esploreremo come integrare queste tecniche con animazioni fluide e interazioni utente.

---
[Curve di Bezier e archi, Combinare tracciati con clip](<07.06 Curve di Bezier e archi, Combinare tracciati con clip.md>) | [Indice](<README.md>) | [Gestione della trasparenza](<07.08 Gestione della trasparenza.md>)