# Audio per applicazioni Canvas

## Introduzione
L'aggiunta di effetti sonori e musica può migliorare significativamente l'esperienza utente nelle applicazioni Canvas, specialmente nei giochi. In questa guida esploreremo come integrare l'audio nelle applicazioni Canvas utilizzando l'API Web Audio.

## L'API Web Audio

Web Audio è un'API JavaScript avanzata per l'elaborazione e la sintesi audio nel browser.

### Creazione di un contesto audio

```javascript
// Creare un contesto audio
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioContext = new AudioContext();
```

### Caricamento e riproduzione di un suono

```javascript
let sound;

// Funzione per caricare un file audio
async function loadSound(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
  return audioBuffer;
}

// Funzione per riprodurre un suono
function playSound(audioBuffer, detune = 0, playbackRate = 1) {
  const source = audioContext.createBufferSource();
  source.buffer = audioBuffer;
  source.detune.value = detune; // Cambia il tono (in centesimi)
  source.playbackRate.value = playbackRate; // Cambia la velocità
  source.connect(audioContext.destination);
  source.start();
  return source;
}

// Utilizzo
async function init() {
  sound = await loadSound('explosion.mp3');
  
  // Esempio: riproduci il suono quando si fa clic sul canvas
  canvas.addEventListener('click', () => {
    playSound(sound);
  });
}

init();
```

## Gestione dell'audio nei giochi Canvas

### Classe Sound Manager

```javascript
class SoundManager {
  constructor() {
    this.AudioContext = window.AudioContext || window.webkitAudioContext;
    this.context = new this.AudioContext();
    this.sounds = new Map();
    this.musicTracks = new Map();
    this.currentMusic = null;
  }

  async load(name, url) {
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    const audioBuffer = await this.context.decodeAudioData(arrayBuffer);
    this.sounds.set(name, audioBuffer);
  }

  play(name, options = {}) {
    const sound = this.sounds.get(name);
    if (!sound) return;
    
    const source = this.context.createBufferSource();
    source.buffer = sound;
    
    // Opzioni
    if (options.loop) source.loop = true;
    if (options.detune) source.detune.value = options.detune;
    if (options.playbackRate) source.playbackRate.value = options.playbackRate;
    
    // Volume control
    const gainNode = this.context.createGain();
    gainNode.gain.value = options.volume !== undefined ? options.volume : 1;
    
    source.connect(gainNode);
    gainNode.connect(this.context.destination);
    source.start();
    
    return { source, gainNode };
  }

  playMusic(name, fadeInTime = 0) {
    // Implementazione per musica di sottofondo con fade
  }
  
  stopMusic(fadeOutTime = 0) {
    // Implementazione per fermare la musica con fade
  }
}
```

### Integrazione con il gioco

```javascript
// Nel file principale del gioco
const soundManager = new SoundManager();

async function loadGameAssets() {
  // Carica grafica, livelli, ecc.
  
  // Carica audio
  await Promise.all([
    soundManager.load('jump', 'sounds/jump.mp3'),
    soundManager.load('coin', 'sounds/coin.mp3'),
    soundManager.load('explosion', 'sounds/explosion.mp3'),
    soundManager.load('theme', 'music/theme.mp3')
  ]);
  
  console.log('Tutti i suoni caricati!');
}

// Nel ciclo di gioco o nei gestori di eventi
function jump() {
  player.velocity.y = -10;
  soundManager.play('jump');
}

function collectCoin() {
  score += 10;
  soundManager.play('coin', { volume: 0.7 });
}
```

## Considerazioni di UX e accessibilità

### Controllo del volume e mute
```javascript
const volumeSlider = document.getElementById('volumeSlider');
const muteButton = document.getElementById('muteButton');

let masterVolume = 1;
let muted = false;

volumeSlider.addEventListener('input', (e) => {
  masterVolume = parseFloat(e.target.value);
  updateVolume();
});

muteButton.addEventListener('click', () => {
  muted = !muted;
  updateVolume();
  muteButton.textContent = muted ? 'Unmute' : 'Mute';
});

function updateVolume() {
  // Master gain node che controlla il volume globale
  masterGainNode.gain.value = muted ? 0 : masterVolume;
}

// Quando si riproduce un suono
function playWithMasterVolume(name) {
  const sound = soundManager.play(name);
  sound.gainNode.connect(masterGainNode);
  return sound;
}
```

### Autoplay e interazione utente
```javascript
// Gestire le restrizioni di autoplay
document.addEventListener('click', initAudio, { once: true });
document.addEventListener('keydown', initAudio, { once: true });

function initAudio() {
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
  
  // Inizia la musica di sfondo
  soundManager.playMusic('theme', 2); // fade in di 2 secondi
}
```

## Conclusione

L'integrazione dell'audio nelle applicazioni Canvas, specialmente nei giochi, migliora significativamente l'esperienza utente. L'API Web Audio offre potenti funzionalità per la gestione dell'audio che possono essere facilmente integrate con la logica dell'applicazione Canvas.

Ricorda di:
- Caricare i suoni in anticipo per evitare ritardi
- Offrire controlli per volume e mute
- Gestire le restrizioni di autoplay
- Considerare l'accessibilità
